name: Security Scan (SAST & DAST)

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - sast
        - dast
      severity_level:
        description: 'Severity levels to scan for'
        required: false
        default: 'HIGH,CRITICAL'
        type: choice
        options:
        - 'HIGH,CRITICAL'
        - 'CRITICAL'
        - 'HIGH'
        - 'MEDIUM,HIGH,CRITICAL'
        - 'LOW,MEDIUM,HIGH,CRITICAL'
      target_path:
        description: 'Path to scan (relative to repository root)'
        required: false
        default: '.'
        type: string

jobs:
  get-changed-files:
    name: Get Changed Files
    runs-on: ubuntu-latest
    outputs:
      python_changes: ${{ steps.filter.outputs.python_files }}
      java_changes: ${{ steps.filter.outputs.java_files }}
      all_changes: ${{ steps.filter.outputs.all_files }}
      dockerfile_changed: ${{ steps.filter.outputs.dockerfile_changed }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get changed files
        id: filter
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          if [ "$EVENT_NAME" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/"$BASE_REF" | tr '\n' ' ')
          else
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | tr '\n' ' ')
          fi
          
          PYTHON_FILES=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep -E '\.py$' | tr '\n' ' ' || echo '')
          JAVA_FILES=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep -E '\.java$' | tr '\n' ' ' || echo '')
          DOCKERFILE_CHANGED=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep -E 'Dockerfile|requirements\.txt' > /dev/null && echo "true" || echo "false")
          
          echo "python_files=$PYTHON_FILES" >> $GITHUB_OUTPUT
          echo "java_files=$JAVA_FILES" >> $GITHUB_OUTPUT
          echo "all_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "dockerfile_changed=$DOCKERFILE_CHANGED" >> $GITHUB_OUTPUT

  bandit-sast:
    name: Bandit SAST Scan
    needs: get-changed-files
    if: |
      (github.event_name != 'workflow_dispatch') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'sast'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit SAST Scan
        run: |
          echo "=== Running Bandit SAST Scan ===" > bandit-report.txt
          bandit -r python_wordstop -f json -o bandit-results.json || true
          echo "Scan Results:" >> bandit-report.txt
          jq -r '.results[] | "[\(.issue_severity)] \(.issue_text) in \(.filename)"' bandit-results.json >> bandit-report.txt || echo "No issues found" >> bandit-report.txt

      - name: Upload Bandit Results
        uses: actions/upload-artifact@v4
        with:
          name: bandit-scan-results
          path: |
            bandit-report.txt
            bandit-results.json
          retention-days: 90

  owasp-dependency-check:
    name: OWASP Dependency Check
    needs: get-changed-files
    if: |
      (github.event_name != 'workflow_dispatch') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'sast'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Run OWASP Dependency Check - Java
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'java-wordstop'
          path: 'java_wordstop'
          format: 'HTML JSON'
          args: >
            --failOnCVSS 7
            --enableRetired

      - name: Run pip-audit for Python Dependencies
        run: |
          pip install pip-audit
          cd python_wordstop
          pip-audit -r requirements.txt -f json > pip-audit-results.json || true
          echo "=== Python Dependencies Scan Results ===" > pip-audit-report.txt
          jq -r '.[] | "[\(.severity)] \(.name) \(.version): \(.vulnerabilities[].id)"' pip-audit-results.json >> pip-audit-report.txt || echo "No issues found" >> pip-audit-report.txt

      - name: Upload Dependency Check Results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-results
          path: |
            dependency-check-report.html
            dependency-check-report.json
            pip-audit-results.json
            pip-audit-report.txt
          retention-days: 90

  trivy-fs-scan:
    name: Trivy Filesystem Scan
    needs: get-changed-files
    if: |
      github.event_name != 'workflow_dispatch' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'sast'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Run Trivy Filesystem Scan
        env:
          PYTHON_CHANGES: ${{ needs.get-changed-files.outputs.python_changes }}
          JAVA_CHANGES: ${{ needs.get-changed-files.outputs.java_changes }}
          SEVERITY: ${{ github.event.inputs.severity_level || 'HIGH,CRITICAL' }}
        run: |
          echo "=== Running Trivy Filesystem Scan ===" > trivy-fs-report.txt
          
          if [ -n "$PYTHON_CHANGES" ]; then
            echo "Scanning Python files..." >> trivy-fs-report.txt
            trivy fs \
              --scanners vuln,secret,config \
              --severity "$SEVERITY" \
              --format json \
              --output python-scan.json \
              python_wordstop/
          fi
          
          if [ -n "$JAVA_CHANGES" ]; then
            echo "Scanning Java files..." >> trivy-fs-report.txt
            trivy fs \
              --scanners vuln,secret,config \
              --severity "$SEVERITY" \
              --format json \
              --output java-scan.json \
              java_wordstop/
          fi
          
          echo "=== Filesystem Scan Results ===" >> trivy-fs-report.txt
          for report in python-scan.json java-scan.json; do
            if [ -f "$report" ]; then
              echo "Results from $report:" >> trivy-fs-report.txt
              jq -r '.Results[] | select(.Vulnerabilities != null or .Secrets != null or .Misconfigurations != null) | 
                (.Vulnerabilities[]? | "[\(.Severity)] Vulnerability - \(.VulnerabilityID): \(.Title)"),
                (.Secrets[]? | "[SECRET] Found - \(.Title): \(.Match)"),
                (.Misconfigurations[]? | "[\(.Severity)] Misconfiguration - \(.ID): \(.Title)")' "$report" >> trivy-fs-report.txt 2>/dev/null || true
            fi
          done
          echo "===================================" >> trivy-fs-report.txt

      - name: Upload Filesystem Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-scan-results
          path: |
            trivy-fs-report.txt
            python-scan.json
            java-scan.json
          retention-days: 90

  java-docker-build:
    name: Build Java Docker Image
    needs: [get-changed-files, trivy-fs-scan]
    if: needs.get-changed-files.outputs.java_changes != '' || contains(needs.get-changed-files.outputs.all_changes, 'java_wordstop/Dockerfile')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: java_wordstop
          format: spdx-json
          output-file: java-sbom.json

      - name: Extract metadata for Java Docker image
        id: meta-java
        env:
          REPO: ${{ github.repository }}
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.REPO }}/java-wordstop
          tags: |
            type=sha,format=long
            type=ref,event=branch
            type=ref,event=tag
            type=ref,event=pr

      - name: Build and push Java image
        uses: docker/build-push-action@v5
        with:
          context: java_wordstop
          file: java_wordstop/Dockerfile
          push: true
          tags: ${{ steps.meta-java.outputs.tags }}
          labels: ${{ steps.meta-java.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner on Java image
        env:
          IMAGE_TAG: sha-${{ github.sha }}
          SEVERITY: ${{ github.event.inputs.severity_level || 'HIGH,CRITICAL' }}
        run: |
          echo "=== Running Trivy Java Container Scan ===" > java-container-scan.txt
          REPO="${{ github.repository }}"
          IMAGE_TO_SCAN="$REGISTRY/$REPO/java-wordstop:$IMAGE_TAG"
          
          echo "Scanning for vulnerabilities..." >> java-container-scan.txt
          trivy image \
            --format json \
            --output java-vuln-scan.json \
            --scanners vuln \
            --severity "$SEVERITY" \
            --exit-code 0 \
            "$IMAGE_TO_SCAN"

          echo "=== Java Container Scan Results ===" >> java-container-scan.txt
          jq -r '.Results[] | select(.Vulnerabilities != null) | .Vulnerabilities[] | "[\(.Severity)] \(.VulnerabilityID): \(.Title)"' java-vuln-scan.json >> java-container-scan.txt

      - name: Upload Java scan results
        uses: actions/upload-artifact@v4
        with:
          name: java-security-results
          path: |
            java-container-scan.txt
            java-vuln-scan.json
            java-sbom.json
          retention-days: 90

  python-docker-build:
    name: Build and Push Python Docker Image
    needs: [get-changed-files, trivy-fs-scan]
    if: needs.get-changed-files.outputs.python_changes != '' || needs.get-changed-files.outputs.dockerfile_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        env:
          REPO: ${{ github.repository }}
        with:
          images: ${{ env.REGISTRY }}/${{ env.REPO }}
          tags: |
            type=sha,format=long
            type=ref,event=branch
            type=ref,event=tag
            type=ref,event=pr

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: python_wordstop
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  trivy-image-scan:
    name: Trivy Container Image Scan
    needs: [python-docker-build, java-docker-build]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      security-events: write
    steps:
      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Run Trivy Container Image Scan
        env:
          IMAGE_TAG: sha-${{ github.sha }}
          SEVERITY: ${{ github.event.inputs.severity_level || 'HIGH,CRITICAL' }}
        run: |
          echo "=== Running Trivy Container Image Scan ===" > container-scan-report.txt
          IMAGE_TO_SCAN="$REGISTRY/$IMAGE_NAME:$IMAGE_TAG"
          REPO="${{ github.repository }}"
          JAVA_IMAGE_TO_SCAN="$REGISTRY/$REPO/java-wordstop:$IMAGE_TAG"
          
          echo "Scanning Python container for vulnerabilities..." >> container-scan-report.txt
          trivy image \
            --format json \
            --output python-vuln-scan.json \
            --scanners vuln \
            --severity "$SEVERITY" \
            --exit-code 0 \
            "$IMAGE_TO_SCAN"
          
          echo "Scanning Python container for misconfigurations..." >> container-scan-report.txt
          trivy image \
            --format json \
            --output python-config-scan.json \
            --scanners config \
            --severity "$SEVERITY" \
            --exit-code 0 \
            "$IMAGE_TO_SCAN"

          echo "Scanning Java container for vulnerabilities..." >> container-scan-report.txt
          trivy image \
            --format json \
            --output java-vuln-scan.json \
            --scanners vuln \
            --severity "$SEVERITY" \
            --exit-code 0 \
            "$JAVA_IMAGE_TO_SCAN"
          
          echo "=== Container Image Scan Results ===" >> container-scan-report.txt
          echo "Python Container Vulnerabilities:" >> container-scan-report.txt
          jq -r '.Results[] | select(.Vulnerabilities != null) | .Vulnerabilities[] | "[\(.Severity)] \(.VulnerabilityID): \(.Title)"' python-vuln-scan.json >> container-scan-report.txt 2>/dev/null || echo "No vulnerabilities found" >> container-scan-report.txt
          
          echo -e "\nPython Container Misconfigurations:" >> container-scan-report.txt
          jq -r '.Results[] | select(.Misconfigurations != null) | .Misconfigurations[] | "[\(.Severity)] \(.ID): \(.Title)"' python-config-scan.json >> container-scan-report.txt 2>/dev/null || echo "No misconfigurations found" >> container-scan-report.txt

          echo -e "\nJava Container Vulnerabilities:" >> container-scan-report.txt
          jq -r '.Results[] | select(.Vulnerabilities != null) | .Vulnerabilities[] | "[\(.Severity)] \(.VulnerabilityID): \(.Title)"' java-vuln-scan.json >> container-scan-report.txt 2>/dev/null || echo "No vulnerabilities found" >> container-scan-report.txt
          
          echo "===================================" >> container-scan-report.txt

      - name: Upload Container Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-container-scan-results
          path: |
            container-scan-report.txt
            python-vuln-scan.json
            python-config-scan.json
            java-vuln-scan.json
          retention-days: 90

  zap-scan:
    name: ZAP DAST Scan
    needs: [python-docker-build, java-docker-build]
    if: |
      github.event_name != 'workflow_dispatch' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'dast'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run ZAP Scan against Containers
        env:
          IMAGE_TAG: sha-${{ github.sha }}
        continue-on-error: true
        run: |
          # Create ZAP hook script for alert filtering
          cat > zap-hook.py << EOL
          def zap_started(zap, target):
              # Ignore common alerts for demo
              zap.alertfilter.add_alertfilter(
                  alertid="10036",
                  url_is_regex="true",
                  url=".*",
                  enabled="true")
              zap.alertfilter.add_alertfilter(
                  alertid="10055",
                  url_is_regex="true",
                  url=".*",
                  enabled="true")
              zap.alertfilter.add_alertfilter(
                  alertid="10106",
                  url_is_regex="true",
                  url=".*",
                  enabled="true")
              zap.alertfilter.add_alertfilter(
                  alertid="90004",
                  url_is_regex="true",
                  url=".*",
                  enabled="true")
          EOL

          # Start Python container
          PYTHON_IMAGE="$REGISTRY/$IMAGE_NAME:$IMAGE_TAG"
          REPO="${{ github.repository }}"
          JAVA_IMAGE="$REGISTRY/$REPO/java-wordstop:$IMAGE_TAG"
          docker pull "$PYTHON_IMAGE"
          docker run -d --name python-wordstop -p 5000:5000 "$PYTHON_IMAGE"

          # Start Java container
          docker pull "$JAVA_IMAGE"
          docker run -d --name java-wordstop -p 8080:8080 "$JAVA_IMAGE"

          # Wait for the applications to start
          sleep 10

          # Run ZAP scan against Python app
          docker pull ghcr.io/zaproxy/zaproxy:stable
          docker run --network host \
            -v ${PWD}:/zap/wrk/:rw \
            --user root \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t http://localhost:5000 \
            -J zap-report-python.json \
            -x zap-report-python.xml \
            -r zap-report-python.html \
            --hook=/zap/wrk/zap-hook.py \
            -z "-config api.disablekey=true -config scanner.attackOnStart=true -config scanner.threadPerHost=5"

          # Run ZAP scan against Java app
          docker run --network host \
            -v ${PWD}:/zap/wrk/:rw \
            --user root \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t http://localhost:8080 \
            -J zap-report-java.json \
            -x zap-report-java.xml \
            -r zap-report-java.html \
            --hook=/zap/wrk/zap-hook.py \
            -z "-config api.disablekey=true -config scanner.attackOnStart=true -config scanner.threadPerHost=5"

      - name: Generate Combined ZAP Report
        if: always()
        run: |
          echo "=== ZAP DAST Scan Results ===" > zap-summary.txt
          echo "Python Application Results:" >> zap-summary.txt
          if [ -f "zap-report-python.json" ]; then
            echo "Found issues:" >> zap-summary.txt
            jq -r '.site[].alerts[] | "[\(.risk)] \(.name): \(.description)"' zap-report-python.json >> zap-summary.txt 2>/dev/null || echo "No issues found or invalid report format" >> zap-summary.txt
          fi

          echo -e "\nJava Application Results:" >> zap-summary.txt
          if [ -f "zap-report-java.json" ]; then
            echo "Found issues:" >> zap-summary.txt
            jq -r '.site[].alerts[] | "[\(.risk)] \(.name): \(.description)"' zap-report-java.json >> zap-summary.txt 2>/dev/null || echo "No issues found or invalid report format" >> zap-summary.txt
          fi
          echo "===============================" >> zap-summary.txt
          cat zap-summary.txt

      - name: Upload ZAP Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-results
          path: |
            zap-summary.txt
            zap-report-*.json
            zap-report-*.xml
            zap-report-*.html
          retention-days: 1
